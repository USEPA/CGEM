#
# Makefile to build the CGEM model
#
# Note:
# - Ensure you load the appropriates modules before building (if applicable).

### =============== User Modifiable Section =============== ###
EXE	= CGEM 
### Build options for specific platforms. 
###INTEL COMPILER
INC   = -I. -I/usr/local/apps/pnetcdf-1.9.0/intel-18.0/include -I/usr/local/apps/netcdf-4.6.3/intel-18.0/include/
LIBS  = -L. -L/usr/local/apps/pnetcdf-1.9.0/intel-18.0/lib -lpnetcdf -L/usr/local/apps/netcdf-4.6.3/intel-18.0/lib -lnetcdff -lnetcdf
F90 = mpiifort
FFLAGS = -O2 -fp-model precise -warn all -traceback -no-diag-error-limit -convert big_endian -ftz 

###GNU COMPILER
#INC   = -I. -I/usr/local/include -I/usr/include/x86_64-linux-gnu/ -I/usr/include -I/usr/local/apps/pnetcdf-1.9.0/gcc-6.1.0/include -I/usr/local/apps/netcdf-4.6.3/gcc-6.1.0/include 
#LIBS  = -L. -L/usr/lib/x86_64-linux-gnu/ -L/usr/local/apps/pnetcdf-1.9.0/gcc-6.1.0/lib -lpnetcdf -L/usr/local/lib -L/usr/local/apps/netcdf-4.6.3/gcc-6.1.0/lib -lnetcdff -L/usr/local/bin -lnetcdf
#F90 = mpif90
#FFLAGS = -Wall -Wextra -pedantic -fimplicit-none -fbacktrace -ffree-line-length-none

### =============== End User Modifiable Section  =============== ####
include main_src/src_files_par
include moc_src/src_files
include cgem_src/src_files
include wqem_src/src_files

maindir=main_src
mocdir=moc_src
cgemdir=cgem_src
wqemdir=wqem_src


CGEM: ${PAR_OBJ} ${SER_OBJ} ${MAIN_OBJ} ${MOC_OBJ} ${CGEM_OBJ} ${WQEM_OBJ}
	$(F90) -o $(EXE) $(FFLAGS) $(DFLAGS) $(INC) $(PAR_OBJ) $(SER_OBJ) $(MAIN_OBJ) ${MOC_OBJ} ${CGEM_OBJ} ${WQEM_OBJ} $(LIBS)


#
# Pattern rules
#

# These items must have compiler optimization disabled
$(NO_OPT_OBJS): %.o: %.F90
	$(F90) -c -O0 $(FFLAGS) $(DFLAGS) $<

$(MAIN_OBJ):%.o: $(maindir)/%.F90
	$(F90) $(INC) -c $(FFLAGS) $(DFLAGS)  $<

$(MOC_OBJ):%.o: $(mocdir)/%.F90
	$(F90) -c $(FFLAGS) $(DFLAGS)  $<

$(OBJ):%.o: %.F90
	$(F90) -c $(FFLAGS) $(DFLAGS) $<

$(CGEM_OBJ):%.o: $(cgemdir)/%.F90
	$(F90) $(INC) -c $(FFLAGS) $(DFLAGS)   $<

$(WQEM_OBJ):%.o: $(wqemdir)/%.F90
	$(F90) $(INC) -c $(FFLAGS) $(DFLAGS)  $<

$(PAR_OBJ):%.o: $(maindir)/%.F90
	$(F90) $(INC) -c  $<

$(SER_OBJ):%.o: $(maindir)/%.F90
	$(F90) $(INC) -c  $<

#
# Miscellaneous targets
#

clean:
	rm -f *.o ${EXE} *.mod *genmod*

tags:
	ctags --language-force=Fortran *.F90

etags:
	etags -l fortran *.F90
